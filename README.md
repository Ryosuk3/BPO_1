# Безопасный файловый менеджер

Консольное приложение для безопасного управления файлами с использованием базы данных PostgreSQL. Реализует все требования безопасности из ТЗ, включая защиту от Path Traversal, SQL Injection, ZIP-бомб, Race Conditions и небезопасной десериализации.

## Особенности

- **Защита от Path Traversal** - все пути валидируются и ограничиваются песочницей
- **Безопасная десериализация JSON/XML** - использование defusedxml и валидация JSON
- **Защита от ZIP-бомб** - ограничения на размер, коэффициент сжатия и количество файлов
- **Защита от Race Conditions** - атомарные операции с блокировками
- **Prepared Statements** - все запросы к БД через SQLAlchemy (защита от SQL Injection)
- **Логирование действий** - все операции пользователей записываются в БД
- **Аутентификация** - безопасное хеширование паролей (bcrypt)
- **Интерактивный REPL** - команды вводятся как в терминале

## Требования

- Python 3.10+
- PostgreSQL (запускается через Docker Compose)
- pip или другой менеджер пакетов Python

## Установка

1. Клонируйте репозиторий

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Запустите PostgreSQL через Docker Compose:
```bash
docker-compose up -d
```


## Запуск

1. Убедитесь, что PostgreSQL запущен:
```bash
docker-compose up -d
docker-compose ps -a
```

2. (Опционально) Инициализируйте базу данных вручную:
```bash
python init_db.py
```
Таблицы создаются автоматически при первом запуске приложения, но в случае чего можно создать вручную

3. Запустите приложение:
```bash
python main.py
```

После запуска откроется интерактивная оболочка. Введите `help` для списка команд.

## Команды

### Пользователи
- `register` - Регистрация нового пользователя
- `login` - Вход в систему
- `logout` - Выход из системы

### Навигация
- `pwd` - Показать текущий путь
- `ls [path]` - Список файлов и директорий
- `cd <path>` - Перейти в директорию (используйте `..` для подъема)
- `clear` - Очистить экран

### Диски
- `disk` - Информация о дисках системы

### Файлы
- `touch <name>` - Создать файл
- `rm <name>` - Удалить файл
- `cat <name>` - Показать содержимое файла
- `wr <name> <content>` - Записать/добавить содержимое в файл

### Директории
- `mkdir <name>` - Создать директорию
- `rmdir <name> [-r]` - Удалить директорию (используйте `-r` для рекурсивного удаления)

### Операции
- `mv <source> <dest>` - Переместить файл или директорию
- `zip <archive> <src...>` - Создать ZIP архив
- `unzip <archive> <dest>` - Распаковать ZIP архив

### Прочее
- `help` - Показать справку
- `exit` - Выход из программы

## Архитектура

```
BPO_1/
├── src/
│   ├── core/           # Ядро приложения
│   │   ├── config.py      # Конфигурация
│   │   ├── database.py    # Работа с БД
│   │   ├── models.py      # Модели SQLAlchemy
│   │   ├── security.py    # Защита от Path Traversal
│   │   ├── locking.py     # Защита от Race Conditions
│   │   ├── serialization.py # Безопасная десериализация
│   │   └── archive.py     # Безопасная работа с ZIP
│   ├── users/          # Модуль пользователей
│   │   └── auth.py        # Аутентификация
│   ├── files/          # Модуль файлов
│   │   └── manager.py     # Менеджер файлов
│   ├── operations/     # Модуль операций
│   │   └── logger.py      # Логирование операций
│   ├── system/         # Системные функции
│   │   └── disks.py       # Информация о дисках
│   └── cli/            # CLI интерфейс
│       └── application.py # Интерактивное приложение
├── main.py             # Точка входа
├── docker-compose.yml  # Конфигурация PostgreSQL
├── requirements.txt    # Зависимости
└── README.md          # Документация
```

## База данных

Приложение использует PostgreSQL для хранения:
- **Users** - пользователи системы
- **Files** - информация о файлах
- **Operations** - журнал операций пользователей



## Безопасность

### Path Traversal
Все пути валидируются функцией `resolve_secure_path()`, которая проверяет, что путь не выходит за пределы песочницы.

### SQL Injection
Все запросы к БД выполняются через SQLAlchemy ORM, который использует prepared statements автоматически.

### ZIP-бомбы
При работе с архивами проверяются:
- Максимальный размер распакованных данных
- Коэффициент сжатия (максимум 100:1)
- Количество файлов в архиве
- Защита от Zip Slip (Path Traversal в архивах)

### Race Conditions
Все операции с файлами выполняются с блокировками через `LockManager`, который предотвращает одновременный доступ к одному ресурсу.

### Десериализация
- JSON: используется стандартный `json.loads()` с обработкой ошибок
- XML: используется `defusedxml` для защиты от XXE и других атак

## Конфигурация

Параметры можно настроить через переменные окружения (файл `.env`):

- `DATABASE_URL` - строка подключения к БД
- `SANDBOX_ROOT` - корневая директория песочницы
- `MAX_FILE_SIZE` - максимальный размер файла (по умолчанию 100 MB)
- `MAX_UPLOAD_SIZE` - максимальный размер загрузки (по умолчанию 20 MB)
- `ZIP_MAX_TOTAL_SIZE` - максимальный размер распаковки (по умолчанию 2 GB)
- `ZIP_MAX_RATIO` - максимальный коэффициент сжатия (по умолчанию 100)
- `ZIP_MAX_FILES` - максимальное количество файлов в архиве (по умолчанию 1000)



